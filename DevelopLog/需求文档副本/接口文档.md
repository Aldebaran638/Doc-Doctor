# 模块接口文档编写规则

## 编写规则
1. **模块名称**：参考需求文档`功能提取`部分
2. **请求方式(函数或者动态库文件)**：如果模块由 TS 编写，则此处写该模块的函数签名；如果模块由其他语言编写，则此处写模块的动态库文件名或导出函数签名
3. **请求参数**：列出所有请求参数，包括参数名称、类型、是否必填、默认值(如果有)以及参数说明
4. **请求示例**：提供一个完整的请求示例
5. **响应参数**：列出所有响应参数，包括参数名称、类型、说明
6. **响应示例**：提供一个完整的响应示例，展示接口的返回结果
7. **错误码**：列出接口可能返回的错误码及其含义（如有）
8. **注意事项**：补充接口使用中的特殊说明或限制

注意：**前端页面绘制模块不用编写接口文档**，这里只描述服务层和数据交互层模块。

---

# Doc-Doctor 接口文档

---

## 一、服务层接口

> 说明：服务层只负责“解析 + 检查 + 过滤 + 调度”，不关心数据库、自增 ID、问题状态等持久化细节。

### 1. 文件语法解析模块

**模块名称**：文件语法解析模块

**请求方式**：
```typescript
function parseFileContent(fileContent: string, filePath: string): ParseResult
```

**请求参数**：

| 参数名      | 类型   | 必填 | 默认值 | 说明                     |
|-------------|--------|------|--------|--------------------------|
| fileContent | string | 是   | -      | 需要被检查的文件内容     |
| filePath    | string | 是   | -      | 文件的相对路径(用于标记) |

**请求示例**：
```typescript
const result = parseFileContent(
  "int add(int a, int b) { return a + b; }",
  "src/math.c"
);
```

**响应参数**：

| 参数名    | 类型          | 说明                         |
|-----------|---------------|------------------------------|
| success   | boolean       | 是否解析成功                 |
| functions | FunctionInfo[]| 解析得到的函数信息列表       |
| errorCode | string?       | 错误码(仅在失败时存在)       |
| error     | string?       | 错误信息(仅在失败时存在)     |

**FunctionInfo 结构**：

| 字段名           | 类型   | 说明                     |
|------------------|--------|--------------------------|
| filePath         | string | 函数所在文件路径         |
| functionName     | string | 函数名                   |
| functionSignature| string | 函数签名                 |
| comment          | string | 函数注释内容(原始文本)   |
| functionContent  | string | 函数体内容(原始文本)     |
| lineNumber       | number | 函数定义所在行号         |
| columnNumber     | number | 函数名所在列号           |

**响应示例**：
```json
{
  "success": true,
  "functions": [
    {
      "filePath": "src/math.c",
      "functionName": "add",
      "functionSignature": "int add(int a, int b)",
      "comment": "/**\n * @brief 加法运算\n * @param a 第一个数\n * @param b 第二个数\n * @return 两数之和\n */",
      "functionContent": "{ return a + b; }",
      "lineNumber": 5,
      "columnNumber": 5
    }
  ],
  "errorCode": null,
  "error": null
}
```

**错误码**：

| 错误码       | 含义               |
|--------------|--------------------|
| SYNTAX_ERROR | 文件存在语法错误   |

**注意事项**：
- 只处理 `.c` 文件，调用方应在传入前先按扩展名过滤
- 该模块不负责文件大小、读写权限等检查，这些由更外层的“文件扫描/总检查模块”负责
- 若文件存在语法错误，`success=false`，`errorCode = "SYNTAX_ERROR"`，`functions` 为空

---

### 2. 函数检查模块

**模块名称**：函数检查模块

**请求方式**：
```typescript
function checkFunction(functionInfo: FunctionInfo): CheckResult
```

**请求参数**：

| 参数名       | 类型        | 必填 | 默认值 | 说明             |
|--------------|-------------|------|--------|------------------|
| functionInfo | FunctionInfo| 是   | -      | 需要被检查的函数 |

**请求示例**：
```typescript
const result = checkFunction({
  filePath: "src/math.c",
  functionName: "add",
  functionSignature: "int add(int a, int b)",
  comment: "// simple comment",
  functionContent: "{ return a + b; }",
  lineNumber: 5,
  columnNumber: 5
});
```

**响应参数**：

| 参数名  | 类型    | 说明           |
|---------|---------|----------------|
| hasIssue| boolean | 是否存在问题   |
| issues  | Issue[] | 问题列表       |

**Issue 结构**：

| 字段名           | 类型   | 说明                                                |
|------------------|--------|-----------------------------------------------------|
| problemType      | number | 问题类型: 1-参数缺失, 2-返回值缺失, 3-函数体缺失, 4-内容变更警告 |
| problemDescription| string| 问题描述                                            |

**响应示例**：
```json
{
  "hasIssue": true,
  "issues": [
    {
      "problemType": 1,
      "problemDescription": "缺少参数 'a' 的 @param 说明"
    },
    {
      "problemType": 2,
      "problemDescription": "缺少 @return 返回值说明"
    }
  ]
}
```

**错误码**：

| 错误码              | 含义                 |
|---------------------|----------------------|
| INVALID_FUNCTION_INFO| 函数信息不完整或无效 |

**注意事项**：
- 遵循 Doxygen 注释格式规范
- 检查 @brief、@param、@return 标签的完整性
- `problemType=4 内容变更警告` 依赖历史版本信息，具体实现可后期扩展

---

### 3. 总检查模块

**模块名称**：总检查模块

**职责说明**：
- 负责统筹一次“项目检查”流程：
  - 扫描需要检查的 `.c` 文件
  - 做文件级过滤（大小、读权限等）
  - 调用 `parseFileContent` 和 `checkFunction`
  - 应用函数白名单规则
  - 汇总为“问题列表”返回
- 不负责将结果写入数据库（持久化交由数据交互层处理）。

**请求方式**：
```typescript
function checkAllFiles(
  filePaths: string[],
  options?: CheckOptions,
  progressCallback?: (progress: number) => void
): Promise<CheckAllResult>
```

**CheckOptions 结构**：

| 字段名          | 类型    | 说明                               |
|-----------------|---------|------------------------------------|
| maxErrors       | number? | 最多收集的错误数量，默认 1000      |
| timeoutMs       | number? | 超时时间(毫秒)，默认 30000         |
| whitelistRules  | WhitelistRules? | 白名单规则(可选)         |

**请求参数**：

| 参数名          | 类型                        | 必填 | 默认值 | 说明                       |
|-----------------|-----------------------------|------|--------|----------------------------|
| filePaths       | string[]                    | 是   | -      | 需要检查的文件路径列表     |
| options         | CheckOptions          | 否   | -      | 检查选项                   |
| progressCallback| (progress: number) => void  | 否   | -      | 进度回调(0-100)            |

**请求示例**：
```typescript
const result = await checkAllFiles(
  ["src/math.c", "src/utils.c"],
  { maxErrors: 1000, timeoutMs: 30000, whitelistRules },
  (progress) => console.log(`进度: ${progress}%`)
);
```

**响应参数**：

| 参数名       | 类型             | 说明                                   |
|--------------|------------------|----------------------------------------|
| success      | boolean          | 是否检查成功                           |
| totalFiles   | number           | 总文件数                               |
| checkedFiles | number           | 已成功检查的文件数                    |
| skippedFiles | SkippedFile[]    | 被跳过的文件列表及原因                |
| problems     | ProblemSummary[] | 所有发现的问题列表(不含数据库字段)    |
| message      | string           | 提示信息                               |

**SkippedFile 结构**：

| 字段名   | 类型   | 说明                                 |
|----------|--------|--------------------------------------|
| filePath | string | 文件路径                             |
| reason   | string | 跳过原因: FILE_TOO_LARGE/NO_READ_PERMISSION/NOT_C_FILE 等 |

**ProblemSummary 结构**：

| 字段名            | 类型   | 说明                          |
|-------------------|--------|-------------------------------|
| problemType       | number | 问题类型（1-4，含义见附录）  |
| filePath          | string | 文件路径                      |
| functionSignature | string | 函数签名                      |
| functionName      | string | 函数名                        |
| lineNumber        | number | 行号                          |
| columnNumber      | number | 列号                          |
| problemDescription| string | 问题描述                      |
| functionSnippet   | string | 函数代码片段(用于前端展示)   |
| checkTimestamp    | string | 检查时间(YYYY-MM-DD HH:MM:SS) |

> 注意：这里的 ProblemSummary 不包含 `id/status`，这些是数据库层的概念。

**响应示例**：
```json
{
  "success": true,
  "totalFiles": 2,
  "checkedFiles": 2,
  "skippedFiles": [],
  "problems": [
    {
      "problemType": 1,
      "filePath": "src/math.c",
      "functionSignature": "int add(int a, int b)",
      "functionName": "add",
      "lineNumber": 5,
      "columnNumber": 5,
      "problemDescription": "缺少参数 'a' 的 @param 说明",
      "functionSnippet": "int add(int a, int b) { return a + b; }",
      "checkTimestamp": "2025-11-25 22:16:00"
    }
  ],
  "message": "检查完成, 发现 1 个问题"
}
```

**错误码**：

| 错误码            | 含义                         |
|-------------------|------------------------------|
| TIMEOUT           | 检查超时(超过 timeoutMs)     |
| CANCELLED         | 检查被取消                   |
| MAX_ERRORS_REACHED| 达到最大错误数(如 1000 条)  |

**注意事项**：
- 最多检查 `maxErrors` 条错误信息，超过后提前结束并返回 `MAX_ERRORS_REACHED`
- 检查超过 `timeoutMs` 时返回 `TIMEOUT`
- 若用户手动触发取消，则返回 `CANCELLED`
- 本模块只返回内存中的问题结果，不直接写入数据库

---

### 4. 函数白名单筛选模块

**模块名称**：函数白名单筛选模块

**请求方式**：
```typescript
function filterByWhitelist(functions: FunctionInfo[], whitelistRules: WhitelistRules): FunctionInfo[]
```

**请求参数**：

| 参数名        | 类型           | 必填 | 默认值 | 说明                 |
|---------------|----------------|------|--------|----------------------|
| functions     | FunctionInfo[] | 是   | -      | 所有函数信息列表     |
| whitelistRules| WhitelistRules | 是   | -      | 白名单规则           |

**WhitelistRules 结构**：

| 字段名             | 类型                     | 说明                         |
|--------------------|--------------------------|------------------------------|
| checkMainFunction  | boolean                  | 是否检查 main 函数          |
| functionWhitelist  | Record<string, string[]> | 函数白名单: 文件路径 -> 函数名列表 |
| fileWhitelist      | string[]                 | 文件白名单(可为目录前缀)    |
| returnTypeWhitelist| string[]                 | 返回值类型白名单(如 ["void"]) |

**请求示例**：
```typescript
const filtered = filterByWhitelist(allFunctions, {
  checkMainFunction: false,
  functionWhitelist: {
    "src/file1.c": ["function1", "function2"]
  },
  fileWhitelist: ["src/legacy/", "test/"],
  returnTypeWhitelist: ["void"]
});
```

**响应参数**：

| 参数名 | 类型           | 说明                                  |
|--------|----------------|---------------------------------------|
| -      | FunctionInfo[] | 过滤后的函数列表(不在白名单内的函数) |

**响应示例**：
```json
[
  {
    "filePath": "src/math.c",
    "functionName": "add",
    "functionSignature": "int add(int a, int b)",
    "comment": "...",
    "functionContent": "...",
    "lineNumber": 5,
    "columnNumber": 5
  }
]
```

**错误码**：

| 错误码               | 含义               |
|----------------------|--------------------|
| INVALID_WHITELIST_RULES | 白名单规则格式错误 |

**注意事项**：
- 使用 `文件路径` + `函数签名` 作为唯一标识，避免同名函数冲突
- main 函数默认在白名单中（可通过 `checkMainFunction` 关闭）
- 文件白名单支持目录前缀匹配

---

### 5. 任务取消模块

**模块名称**：任务取消模块

**请求方式**：
```typescript
function cancelCurrentCheck(): CancelResult
```

**请求参数**：

| 参数名 | 类型 | 必填 | 默认值 | 说明   |
|--------|------|------|--------|--------|
| -      | -    | -    | -      | 无参数 |

**请求示例**：
```typescript
const result = cancelCurrentCheck();
```

**响应参数**：

| 参数名  | 类型    | 说明           |
|---------|---------|----------------|
| success | boolean | 是否取消成功   |
| message | string  | 提示信息       |

**响应示例**：
```json
{
  "success": true,
  "message": "检查任务已取消"
}
```

**错误码**：

| 错误码        | 含义                     |
|---------------|--------------------------|
| NO_RUNNING_TASK| 当前没有正在运行的检查任务 |

**注意事项**：
- 需要保证与总检查模块之间的线程/任务同步安全
- 若同时触发多次检查，应取消上一次未完成的检查

---

### 6. 工作区跳转模块

**模块名称**：工作区跳转模块

**请求方式**：
```typescript
function jumpToLocation(filePath: string, lineNumber: number, columnNumber: number): JumpResult
```

**请求参数**：

| 参数名     | 类型   | 必填 | 默认值 | 说明             |
|------------|--------|------|--------|------------------|
| filePath   | string | 是   | -      | 文件路径         |
| lineNumber | number | 是   | -      | 函数所在行号     |
| columnNumber| number| 是   | -      | 函数名所在列号   |

**请求示例**：
```typescript
const result = jumpToLocation("src/math.c", 5, 5);
```

**响应参数**：

| 参数名  | 类型    | 说明           |
|---------|---------|----------------|
| success | boolean | 是否跳转成功   |
| message | string  | 提示信息       |

**响应示例**：
```json
{
  "success": true,
  "message": "已跳转到 src/math.c:5:5"
}
```

**错误码**：

| 错误码           | 含义         |
|------------------|--------------|
| FILE_NOT_FOUND   | 文件不存在   |
| FUNCTION_NOT_FOUND| 函数不存在  |

**注意事项**：
- 若文件已被删除，应在输出框和弹窗双重提示
- 若函数已被删除，应在输出框和弹窗双重提示
- 跳转后光标定位到指定行和列

---

### 7. 设置配置读取模块

**模块名称**：设置配置读取模块

**请求方式**：
```typescript
function loadSettings(settingsContent: string): LoadSettingsResult
```

**请求参数**：

| 参数名         | 类型   | 必填 | 默认值 | 说明                 |
|----------------|--------|------|--------|----------------------|
| settingsContent| string | 是   | -      | settings.json 文件内容 |

**请求示例**：
```typescript
const result = loadSettings(`{
  "doc-doctor.checkMainFunction": false,
  "doc-doctor.functionWhitelist": {
    "src/file1.c": ["function1"]
  }
}`);
```

**响应参数**：

| 参数名  | 类型           | 说明                                   |
|---------|----------------|----------------------------------------|
| success | boolean        | 是否加载成功(解析是否成功)            |
| settings| WhitelistRules | 实际生效的设置(默认或解析成功后的结果) |
| message | string         | 提示信息                               |

**响应示例**：
```json
{
  "success": true,
  "settings": {
    "checkMainFunction": false,
    "functionWhitelist": {
      "src/file1.c": ["function1"]
    },
    "fileWhitelist": [],
    "returnTypeWhitelist": []
  },
  "message": "设置加载成功"
}
```

**错误码**：

| 错误码              | 含义                 |
|---------------------|----------------------|
| SETTINGS_NOT_FOUND  | settings.json 不存在 |
| SETTINGS_SYNTAX_ERROR| settings.json 语法错误 |

**注意事项**：
- 如果配置文件不存在或语法错误，返回的 `settings` 为默认设置，但 `success=false`，并在 `message` 中说明原因
- 配置文件变更时，外层监听模块应重新调用该函数并更新内存中的配置
- 默认设置：main 函数不检查，其他全部检查

---

## 二、数据交互层接口（TS 部分）

> 说明：TS 层负责把服务层的 ProblemSummary 转换为数据库记录的结构，并通过 C++ 动态库读写 SQLite。

### 8. 数据库存储模块 (TS)

**模块名称**：数据库存储模块 (TS)

**请求方式**：
```typescript
function saveProblemsToDB(problems: ProblemSummary[]): Promise<SaveResult>
```

**请求参数**：

| 参数名   | 类型              | 必填 | 默认值 | 说明                 |
|----------|-------------------|------|--------|----------------------|
| problems | ProblemSummary[]  | 是   | -      | 一次检查得到的问题列表 |

**请求示例**：
```typescript
const result = await saveProblemsToDB([
  {
    problemType: 1,
    filePath: "src/math.c",
    functionSignature: "int add(int a, int b)",
    functionName: "add",
    lineNumber: 5,
    columnNumber: 5,
    problemDescription: "缺少参数说明",
    functionSnippet: "int add(int a, int b) { return a + b; }",
    checkTimestamp: "2025-11-25 22:16:00"
  }
]);
```

**响应参数**：

| 参数名  | 类型    | 说明                               |
|---------|---------|------------------------------------|
| success | boolean | 是否全部存储成功                   |
| count   | number  | 实际成功写入的记录数               |
| message | string  | 提示信息                           |

**响应示例**：
```json
{
  "success": true,
  "count": 1,
  "message": "已写入 1 条问题记录"
}
```

**错误码**：

| 错误码             | 含义             |
|--------------------|------------------|
| DB_CONNECTION_ERROR| 数据库连接失败   |
| DB_WRITE_ERROR     | 数据库写入失败   |

**注意事项**：
- 通常在每次检查前应清空旧的检查结果（可由调用方先调用“清空接口”或在 C++ 层实现重置逻辑）
- 该模块内部会调用 C++ 的 `saveProblem` 等函数

---

### 9. 数据库读取模块 (TS)

**模块名称**：数据库读取模块 (TS)

**请求方式**：
```typescript
function loadProblemsFromDB(): Promise<LoadResult>
```

**请求参数**：

| 参数名 | 类型 | 必填 | 默认值 | 说明   |
|--------|------|------|--------|--------|
| -      | -    | -    | -      | 无参数 |

**响应参数**：

| 参数名  | 类型            | 说明                             |
|---------|-----------------|----------------------------------|
| success | boolean         | 是否读取成功                     |
| problems| ProblemRecord[] | 数据库中所有问题记录(含 id/status)|
| message | string          | 提示信息                         |

**ProblemRecord 结构**（对应数据库表）：

| 字段名            | 类型   | 说明                                   |
|-------------------|--------|----------------------------------------|
| id                | number | 问题记录唯一标识                       |
| problemType       | number | 问题类型                               |
| filePath          | string | 函数所在文件的相对路径                 |
| functionSignature | string | 函数签名                               |
| functionName      | string | 函数名                                 |
| lineNumber        | number | 函数定义所在行号                       |
| columnNumber      | number | 函数名所在列号                         |
| problemDescription| string | 问题描述                               |
| functionSnippet   | string | 函数代码片段                           |
| checkTimestamp    | string | 检查时间(YYYY-MM-DD HH:MM:SS)          |
| status            | number | 问题状态: 0-normal, 1-ignored          |

**响应示例**：
```json
{
  "success": true,
  "problems": [
    {
      "id": 1,
      "problemType": 1,
      "filePath": "src/math.c",
      "functionSignature": "int add(int a, int b)",
      "functionName": "add",
      "lineNumber": 5,
      "columnNumber": 5,
      "problemDescription": "缺少参数说明",
      "functionSnippet": "int add(int a, int b) { return a + b; }",
      "checkTimestamp": "2025-11-25 22:16:00",
      "status": 0
    }
  ],
  "message": "成功读取 1 条问题记录"
}
```

**错误码**：

| 错误码             | 含义           |
|--------------------|----------------|
| DB_CONNECTION_ERROR| 数据库连接失败 |
| DB_READ_ERROR      | 数据库读取失败 |

**注意事项**：
- 该模块内部会调用 C++ 的 `loadAllProblems` 等函数
- 通常在插件启动时调用一次，用于恢复上一次检查结果

---

## 三、数据交互层接口（CPP 部分）

> 说明：C++ 动态库是对 SQLite 的薄封装，直接操作数据库表结构，TS 通过 JSON 与其交互。

### 10. 数据库存储模块 (CPP)

**模块名称**：数据库存储模块 (CPP)

**请求方式**：动态库文件 `doc_doctor_db.dll` (Windows) / `doc_doctor_db.so` (Linux)

**导出函数签名**：
```cpp
int saveProblem(const char* problemJson);
```

**请求参数**：

| 参数名     | 类型        | 必填 | 默认值 | 说明                     |
|------------|-------------|------|--------|--------------------------|
| problemJson| const char* | 是   | -      | JSON 格式的问题记录数据 |

**problemJson 示例**：
```json
{
  "problemType": 1,
  "filePath": "src/math.c",
  "functionSignature": "int add(int a, int b)",
  "functionName": "add",
  "lineNumber": 5,
  "columnNumber": 5,
  "problemDescription": "缺少参数说明",
  "functionSnippet": "int add(int a, int b) { return a + b; }",
  "checkTimestamp": "2025-11-25 22:16:00",
  "status": 0
}
```

**响应参数**：

| 参数名 | 类型 | 说明                               |
|--------|------|------------------------------------|
| -      | int  | 该问题在数据库中的 ID，失败返回 -1 |

**响应示例**：
```
1   // 成功，返回问题 ID
-1  // 失败
```

**错误码**：

| 错误码 | 含义     |
|--------|----------|
| -1     | 存储失败 |

**注意事项**：
- 需要将 C++ 源文件编译为 `.dll`(Windows) 或 `.so`(Linux) 动态库
- 使用 SQLite 数据库
- 传入的 JSON 必须符合预期结构

---

### 11. 数据库读取模块 (CPP)

**模块名称**：数据库读取模块 (CPP)

**请求方式**：动态库文件 `doc_doctor_db.dll` (Windows) / `doc_doctor_db.so` (Linux)

**导出函数签名**：
```cpp
const char* loadAllProblems();
```

**请求参数**：

| 参数名 | 类型 | 必填 | 默认值 | 说明   |
|--------|------|------|--------|--------|
| -      | -    | -    | -      | 无参数 |

**响应参数**：

| 参数名 | 类型        | 说明                                             |
|--------|-------------|--------------------------------------------------|
| -      | const char* | JSON 数组格式的所有问题信息，失败返回 NULL      |

**响应示例**：
```json
[
  {
    "id": 1,
    "problemType": 1,
    "filePath": "src/math.c",
    "functionSignature": "int add(int a, int b)",
    "functionName": "add",
    "lineNumber": 5,
    "columnNumber": 5,
    "problemDescription": "缺少参数说明",
    "functionSnippet": "int add(int a, int b) { return a + b; }",
    "checkTimestamp": "2025-11-25 22:16:00",
    "status": 0
  }
]
```

**错误码**：

| 错误码 | 含义   |
|--------|--------|
| NULL   | 读取失败 |

**注意事项**：
- 返回的字符串通常由 C++ 侧分配内存，调用方在使用后需要调用约定的释放函数(例如 `freeResult(const char*)`)，以避免内存泄漏
- 同样基于 SQLite 数据库表 `problems`

---

## 四、附录

### 1. 问题类型枚举（ProblemType）

| 值 | 含义       |
|----|------------|
| 1  | 参数缺失   |
| 2  | 返回值缺失 |
| 3  | 函数体缺失 |
| 4  | 内容变更警告 |
| 5  | 语法错误(仅文件级/数据库层使用) |

> 说明：`5-语法错误` 仅在“文件解析失败”或数据库记录中出现，`checkFunction` 模块本身只产出 1~4 类型。

### 2. 问题状态枚举（ProblemStatus）

| 值 | 含义            |
|----|-----------------|
| 0  | normal(正常)    |
| 1  | ignored(已完成) |

### 3. 数据库表结构（problems）

```sql
CREATE TABLE problems (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    problem_type INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    function_signature TEXT,
    function_name TEXT NOT NULL,
    line_number INTEGER DEFAULT 1,
    column_number INTEGER DEFAULT 1,
    problem_description TEXT,
    function_snippet TEXT,
    check_timestamp DATETIME NOT NULL,
    status INTEGER DEFAULT 0
);
```
