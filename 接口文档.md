# 模块接口文档编写规则

## 编写规则
1. **模块名称**：参考需求文档`功能提取`部分
4. **请求方式(函数或者动态库文件)**：如果模块由TS编写,则此处写该模块的函数签名;如果模块由其他语言编写,则此处写模块的动态库文件名
5. **请求参数**：列出所有请求参数,包括参数名称,类型,是否必填,默认值(如果有)以及参数说明.
6. **请求示例**：提供一个完整的请求示例.
7. **响应参数**：列出所有响应参数,包括参数名称,类型,说明.
8. **响应示例**：提供一个完整的响应示例,展示接口的返回结果.
9. **错误码**：列出接口可能返回的错误码及其含义.
10. **注意事项**：补充接口使用中的特殊说明或限制.

注意,前端模块不用编写接口文档

---

# Doc-Doctor 接口文档

---

## 服务层接口

### 1. 文件语法解析模块

**模块名称**: 文件语法解析模块

**请求方式**: 

```typescript
function parseFileContent(fileContent: string, filePath: string): ParseResult
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| fileContent | string | 是 | - | 需要被检查的文件内容 |
| filePath | string | 是 | - | 文件的相对路径 |

**请求示例**:
```typescript
const result = parseFileContent(
  "int add(int a, int b) { return a + b; }",
  "src/math.c"
);
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否解析成功 |
| functions | FunctionInfo[] | 函数信息列表 |
| error | string? | 错误信息(如果有) |

**FunctionInfo 结构**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| filePath | string | 函数所在文件路径 |
| functionName | string | 函数名 |
| functionSignature | string | 函数签名 |
| comment | string | 函数注释内容 |
| functionContent | string | 函数体内容 |
| lineNumber | number | 函数定义所在行号 |
| columnNumber | number | 函数名所在列号 |

**响应示例**:
```json
{
  "success": true,
  "functions": [
    {
      "filePath": "src/math.c",
      "functionName": "add",
      "functionSignature": "int add(int a, int b)",
      "comment": "/**\n * @brief 加法运算\n * @param a 第一个数\n * @param b 第二个数\n * @return 两数之和\n */",
      "functionContent": "{ return a + b; }",
      "lineNumber": 5,
      "columnNumber": 5
    }
  ],
  "error": null
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| SYNTAX_ERROR | 文件存在语法错误 |
| FILE_TOO_LARGE | 文件大小超过1MB |
| NO_READ_PERMISSION | 文件无读取权限 |

**注意事项**:
- 只处理 `.c` 文件
- 排除匿名函数
- 如果文件存在语法错误,返回 success=false 并跳过该文件
- 文件大小超过1MB时自动跳过

---

### 2. 函数检查模块

**模块名称**: 函数检查模块

**请求方式**: 
```typescript
function checkFunction(functionInfo: FunctionInfo): CheckResult
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| functionInfo | FunctionInfo | 是 | - | 需要被检查的函数信息 |

**请求示例**:
```typescript
const result = checkFunction({
  filePath: "src/math.c",
  functionName: "add",
  functionSignature: "int add(int a, int b)",
  comment: "// simple comment",
  functionContent: "{ return a + b; }",
  lineNumber: 5,
  columnNumber: 5
});
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| hasIssue | boolean | 是否存在问题 |
| issues | Issue[] | 问题列表 |

**Issue 结构**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| problemType | number | 问题类型: 1-参数缺失, 2-返回值缺失, 3-函数体缺失, 4-内容变更警告 |
| problemDescription | string | 问题描述 |

**响应示例**:
```json
{
  "hasIssue": true,
  "issues": [
    {
      "problemType": 1,
      "problemDescription": "缺少参数 'a' 的 @param 说明"
    },
    {
      "problemType": 2,
      "problemDescription": "缺少 @return 返回值说明"
    }
  ]
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| INVALID_FUNCTION_INFO | 函数信息不完整或无效 |

**注意事项**:
- 遵循 Doxygen 注释格式规范
- 检查 @brief、@param、@return 标签的完整性
- 对比函数内容变更需要访问历史记录

---

### 3. 总检查模块

**模块名称**: 总检查模块

**请求方式**: 
```typescript
function checkAllFiles(filePaths: string[], progressCallback?: (progress: number) => void): Promise<CheckAllResult>
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| filePaths | string[] | 是 | - | 需要检查的文件路径列表 |
| progressCallback | (progress: number) => void | 否 | - | 进度回调函数 |

**请求示例**:
```typescript
const result = await checkAllFiles(
  ["src/math.c", "src/utils.c"],
  (progress) => console.log(`进度: ${progress}%`)
);
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否检查成功 |
| totalFiles | number | 总文件数 |
| checkedFiles | number | 已检查文件数 |
| skippedFiles | string[] | 跳过的文件列表 |
| problems | Problem[] | 所有问题列表 |
| message | string | 提示信息 |

**Problem 结构**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | number | 问题ID(由数据库生成) |
| problemType | number | 问题类型 |
| filePath | string | 文件路径 |
| functionSignature | string | 函数签名 |
| functionName | string | 函数名 |
| lineNumber | number | 行号 |
| columnNumber | number | 列号 |
| problemDescription | string | 问题描述 |
| functionSnippet | string | 函数代码片段 |
| checkTimestamp | string | 检查时间 |
| status | number | 问题状态: 0-正常, 1-已完成 |

**响应示例**:

```json
{
  "success": true,
  "totalFiles": 2,
  "checkedFiles": 2,
  "skippedFiles": [],
  "problems": [
    {
      "id": 1,
      "problemType": 1,
      "filePath": "src/math.c",
      "functionSignature": "int add(int a, int b)",
      "functionName": "add",
      "lineNumber": 5,
      "columnNumber": 5,
      "problemDescription": "缺少参数 'a' 的 @param 说明",
      "functionSnippet": "int add(int a, int b) { return a + b; }",
      "checkTimestamp": "2025-11-25 22:16:00",
      "status": 0
    }
  ],
  "message": "检查完成,发现 1 个问题"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| TIMEOUT | 检查超时(超过30秒) |
| CANCELLED | 检查被取消 |
| MAX_ERRORS_REACHED | 达到最大错误数(1000条) |

**注意事项**:
- 最多检查1000条错误信息
- 检查超过30秒会提示用户可以取消
- 支持进度回调
- 异步执行,返回 Promise

---

### 4. 函数白名单筛选模块

**模块名称**: 函数白名单筛选模块

**请求方式**: 
```typescript
function filterByWhitelist(functions: FunctionInfo[], whitelistRules: WhitelistRules): FunctionInfo[]
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| functions | FunctionInfo[] | 是 | - | 所有函数信息列表 |
| whitelistRules | WhitelistRules | 是 | - | 白名单规则 |

**WhitelistRules 结构**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| checkMainFunction | boolean | 是否检查main函数 |
| functionWhitelist | Record<string, string[]> | 函数白名单: 文件路径 -> 函数名列表 |
| fileWhitelist | string[] | 文件白名单 |
| returnTypeWhitelist | string[] | 返回值类型白名单 |

**请求示例**:
```typescript
const filtered = filterByWhitelist(allFunctions, {
  checkMainFunction: false,
  functionWhitelist: {
    "src/file1.c": ["function1", "function2"]
  },
  fileWhitelist: ["src/legacy/", "test/"],
  returnTypeWhitelist: ["void"]
});
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| - | FunctionInfo[] | 过滤后的函数列表(不在白名单内的函数) |

**响应示例**:
```json
[
  {
    "filePath": "src/math.c",
    "functionName": "add",
    "functionSignature": "int add(int a, int b)",
    "comment": "...",
    "functionContent": "...",
    "lineNumber": 5,
    "columnNumber": 5
  }
]
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| INVALID_WHITELIST_RULES | 白名单规则格式错误 |

**注意事项**:
- 使用 `文件路径` + `函数签名` 作为唯一标识
- main 函数默认在白名单中
- 文件白名单支持目录匹配

---

### 5. 任务取消模块

**模块名称**: 任务取消模块

**请求方式**: 
```typescript
function cancelCurrentCheck(): CancelResult
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| - | - | - | - | 无参数 |

**请求示例**:
```typescript
const result = cancelCurrentCheck();
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否取消成功 |
| message | string | 提示信息 |

**响应示例**:
```json
{
  "success": true,
  "message": "检查任务已取消"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| NO_RUNNING_TASK | 当前没有正在运行的检查任务 |

**注意事项**:
- 立即终止正在进行的检查工作
- 需要保证线程安全
- 如果同时触发多次检查,取消上一次未完成的检查

---

### 6. 工作区跳转模块

**模块名称**: 工作区跳转模块

**请求方式**: 
```typescript
function jumpToLocation(filePath: string, lineNumber: number, columnNumber: number): JumpResult
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| filePath | string | 是 | - | 文件路径 |
| lineNumber | number | 是 | - | 函数所在行号 |
| columnNumber | number | 是 | - | 函数名所在列号 |

**请求示例**:
```typescript
const result = jumpToLocation("src/math.c", 5, 5);
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否跳转成功 |
| message | string | 提示信息 |

**响应示例**:
```json
{
  "success": true,
  "message": "已跳转到 src/math.c:5:5"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| FILE_NOT_FOUND | 文件不存在 |
| FUNCTION_NOT_FOUND | 函数不存在 |

**注意事项**:
- 若文件已被删除,在输出框和弹窗双重提示
- 若函数已被删除,在输出框和弹窗双重提示
- 跳转后光标定位到指定行和列

---

### 7. 设置配置读取模块

**模块名称**: 设置配置读取模块

**请求方式**: 
```typescript
function loadSettings(settingsContent: string): LoadSettingsResult
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| settingsContent | string | 是 | - | settings.json 文件内容 |

**请求示例**:
```typescript
const result = loadSettings(`{
  "doc-doctor.checkMainFunction": false,
  "doc-doctor.functionWhitelist": {
    "src/file1.c": ["function1"]
  }
}`);
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否加载成功 |
| settings | WhitelistRules | 解析后的设置配置 |
| message | string | 提示信息 |

**响应示例**:
```json
{
  "success": true,
  "settings": {
    "checkMainFunction": false,
    "functionWhitelist": {
      "src/file1.c": ["function1"]
    },
    "fileWhitelist": [],
    "returnTypeWhitelist": []
  },
  "message": "设置加载成功"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| SETTINGS_NOT_FOUND | settings.json 不存在 |
| SETTINGS_SYNTAX_ERROR | settings.json 语法错误 |

**注意事项**:
- 如果配置文件不存在或语法错误,使用默认设置
- 配置文件变更时自动重新加载
- 默认设置: main 函数不检查,其他全部检查
- 配置变更后可能触发自动重新检查

---

## 数据交互层接口(TS部分)

### 8. 数据库存储模块

**模块名称**: 数据库存储模块(TS)

**请求方式**: 
```typescript
function saveProblemToDB(problem: Problem): Promise<SaveResult>
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| problem | Problem | 是 | - | 函数问题相关信息 |

**请求示例**:
```typescript
const result = await saveProblemToDB({
  problemType: 1,
  filePath: "src/math.c",
  functionSignature: "int add(int a, int b)",
  functionName: "add",
  lineNumber: 5,
  columnNumber: 5,
  problemDescription: "缺少参数说明",
  functionSnippet: "int add(int a, int b) { return a + b; }",
  checkTimestamp: "2025-11-25 22:16:00",
  status: 0
});
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否存储成功 |
| id | number | 该问题在数据库中的ID |
| message | string | 提示信息 |

**响应示例**:
```json
{
  "success": true,
  "id": 1,
  "message": "问题已保存到数据库"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| DB_CONNECTION_ERROR | 数据库连接失败 |
| DB_WRITE_ERROR | 数据库写入失败 |

**注意事项**:
- 该模块与 CPP 部分的数据库存储模块对接
- 异步执行,返回 Promise
- 每次检查前清空上一次的检查结果

---

### 9. 数据库读取模块

**模块名称**: 数据库读取模块(TS)

**请求方式**: 
```typescript
function loadProblemsFromDB(): Promise<LoadResult>
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| - | - | - | - | 无参数 |

**请求示例**:
```typescript
const result = await loadProblemsFromDB();
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否读取成功 |
| problems | Problem[] | 所有问题列表 |
| message | string | 提示信息 |

**响应示例**:
```json
{
  "success": true,
  "problems": [
    {
      "id": 1,
      "problemType": 1,
      "filePath": "src/math.c",
      "functionSignature": "int add(int a, int b)",
      "functionName": "add",
      "lineNumber": 5,
      "columnNumber": 5,
      "problemDescription": "缺少参数说明",
      "functionSnippet": "int add(int a, int b) { return a + b; }",
      "checkTimestamp": "2025-11-25 22:16:00",
      "status": 0
    }
  ],
  "message": "成功读取 1 条问题记录"
}
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| DB_CONNECTION_ERROR | 数据库连接失败 |
| DB_READ_ERROR | 数据库读取失败 |

**注意事项**:
- 该模块与 CPP 部分的数据库读取模块对接
- 异步执行,返回 Promise
- 插件启动时自动加载上一次的检查结果

---

## 数据交互层接口(CPP部分)

### 10. 数据库存储模块(CPP)

**模块名称**: 数据库存储模块(CPP)

**请求方式**: 动态库文件 `doc_doctor_db.dll` (Windows) / `doc_doctor_db.so` (Linux)

**函数签名**:
```cpp
int saveProblem(const char* problemJson);
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| problemJson | const char* | 是 | - | JSON格式的问题信息 |

**请求示例**:
```cpp
const char* json = R"({
  "problemType": 1,
  "filePath": "src/math.c",
  "functionSignature": "int add(int a, int b)",
  "functionName": "add",
  "lineNumber": 5,
  "columnNumber": 5,
  "problemDescription": "缺少参数说明",
  "functionSnippet": "int add(int a, int b) { return a + b; }",
  "checkTimestamp": "2025-11-25 22:16:00",
  "status": 0
})";

int id = saveProblem(json);
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| - | int | 该问题在数据库中的ID,失败返回-1 |

**响应示例**:
```
1  // 成功,返回问题ID
-1 // 失败
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| -1 | 存储失败 |

**注意事项**:
- 需要将函数文件编译为 `.dll` 动态库(Windows)或 `.so` 动态库(Linux)
- 使用 SQLite 数据库
- JSON 格式必须严格符合规范

---

### 11. 数据库读取模块(CPP)

**模块名称**: 数据库读取模块(CPP)

**请求方式**: 动态库文件 `doc_doctor_db.dll` (Windows) / `doc_doctor_db.so` (Linux)

**函数签名**:
```cpp
const char* loadAllProblems();
```

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| - | - | - | - | 无参数 |

**请求示例**:
```cpp
const char* result = loadAllProblems();
```

**响应参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| - | const char* | JSON数组格式的所有问题信息,失败返回NULL |

**响应示例**:
```json
[
  {
    "id": 1,
    "problemType": 1,
    "filePath": "src/math.c",
    "functionSignature": "int add(int a, int b)",
    "functionName": "add",
    "lineNumber": 5,
    "columnNumber": 5,
    "problemDescription": "缺少参数说明",
    "functionSnippet": "int add(int a, int b) { return a + b; }",
    "checkTimestamp": "2025-11-25 22:16:00",
    "status": 0
  }
]
```

**错误码**:

| 错误码 | 含义 |
|--------|------|
| NULL | 读取失败 |

**注意事项**:
- 需要将函数文件编译为 `.dll` 动态库(Windows)或 `.so` 动态库(Linux)
- 使用 SQLite 数据库
- 返回的字符串需要在使用后释放内存

---

## 附录

### 问题类型枚举

| 值 | 含义 |
|----|------|
| 1 | 参数缺失 |
| 2 | 返回值缺失 |
| 3 | 函数体缺失 |
| 4 | 内容变更警告 |
| 5 | 语法错误 |

### 问题状态枚举

| 值 | 含义 |
|----|------|
| 0 | normal(正常) |
| 1 | ignored(已完成) |

### 数据库表结构

```sql
CREATE TABLE problems (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    problem_type INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    function_signature TEXT,
    function_name TEXT NOT NULL,
    line_number INTEGER DEFAULT 1,
    column_number INTEGER DEFAULT 1,
    problem_description TEXT,
    function_snippet TEXT,
    check_timestamp DATETIME NOT NULL,
    status INTEGER DEFAULT 0
);
```
