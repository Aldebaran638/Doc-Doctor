# Doc-Doctor 数据库模块 (C++)

本目录包含 Doc-Doctor 的 C++ 数据库后端，使用 SQLite3 存储函数注释问题。

## 目录结构

```
native/
├── CMakeLists.txt      # CMake 构建配置
├── README.md           # 本文件
├── src/
│   ├── database.h      # 头文件（导出接口）
│   ├── database.cpp    # 实现文件
│   └── main.cpp        # 测试程序（可选）
└── build/              # 编译输出目录
    └── doc_doctor_db.dll (Windows)
    └── doc_doctor_db.so  (Linux)
```

## 依赖

1. **SQLite3** - 数据库引擎
2. **nlohmann/json** - JSON 解析库（header-only）

### Windows 安装依赖 (vcpkg)

```bash
# 安装 vcpkg（如果还没有）
git clone https://github.com/microsoft/vcpkg.git
cd vcpkg
./bootstrap-vcpkg.bat

# 安装依赖
./vcpkg install sqlite3:x64-windows
./vcpkg install nlohmann-json:x64-windows
```

### Ubuntu/Debian 安装依赖

```bash
sudo apt-get install libsqlite3-dev nlohmann-json3-dev
```

### macOS 安装依赖

```bash
brew install sqlite3 nlohmann-json
```

## 编译

### 使用 CMake

```bash
cd native
mkdir build && cd build

# Windows (使用 vcpkg)
cmake .. -DCMAKE_TOOLCHAIN_FILE=[vcpkg根目录]/scripts/buildsystems/vcpkg.cmake

# Linux/macOS
cmake ..

# 编译
cmake --build . --config Release
```

### 直接使用 g++ (Linux/macOS)

```bash
cd native/src
g++ -shared -fPIC -o ../build/doc_doctor_db.so database.cpp -lsqlite3 -std=c++17 -fvisibility=hidden
```

### 直接使用 MSVC (Windows)

```cmd
cd native\src
cl /LD /EHsc /std:c++17 database.cpp /Fe:..\build\doc_doctor_db.dll /link sqlite3.lib
```

## 编译测试程序

```bash
cd native/src
g++ -o ../build/test_db main.cpp database.cpp -lsqlite3 -std=c++17
../build/test_db
```

## 导出接口

| 函数 | 说明 |
|------|------|
| `initDatabase(dbPath)` | 初始化数据库，创建文件和表 |
| `saveProblem(json)` | 存储问题，返回 ID |
| `loadAllProblems()` | 读取所有问题，返回 JSON |
| `updateProblemStatus(id, status)` | 更新问题状态 |
| `clearProblems()` | 清空所有问题 |
| `closeDatabase()` | 关闭数据库连接 |
| `freeString(str)` | 释放字符串内存（当前为空实现） |

## JSON 格式

### 输入（saveProblem）

```json
{
  "problem_type": 3,
  "file_path": "src/main.c",
  "function_signature": "int main(int argc, char* argv[])",
  "function_name": "main",
  "line_number": 10,
  "column_number": 1,
  "problem_description": "缺少函数功能描述（@brief）",
  "function_snippet": "int main(...) { ... }",
  "check_timestamp": "2025-12-22T22:00:00.000Z",
  "status": 0
}
```

### 输出（loadAllProblems）

```json
[
  {
    "id": 1,
    "problem_type": 3,
    "file_path": "src/main.c",
    "function_signature": "int main(int argc, char* argv[])",
    "function_name": "main",
    "line_number": 10,
    "column_number": 1,
    "problem_description": "缺少函数功能描述（@brief）",
    "function_snippet": "int main(...) { ... }",
    "check_timestamp": "2025-12-22T22:00:00.000Z",
    "status": 0
  }
]
```

## 问题类型枚举

| 值 | 含义 |
|----|------|
| 1 | 参数说明缺失 |
| 2 | 返回值说明缺失 |
| 3 | 函数功能说明缺失 |
| 4 | 内容变更警告 |
| 5 | 语法错误 |

## 状态枚举

| 值 | 含义 |
|----|------|
| 0 | 正常 |
| 1 | 已完成/已忽略 |


